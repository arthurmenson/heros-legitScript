<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Domain Diagnostic - Heros Health</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dc3545 0%, #6f42c1 100%);
            color: white;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .diagnostic-panel {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }
        
        .result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        .pass {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid #28a745;
            color: #d4edda;
        }
        
        .fail {
            background: rgba(220, 53, 69, 0.3);
            border: 1px solid #dc3545;
            color: #f8d7da;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #ffc107;
            color: #fff3cd;
        }
        
        .info {
            background: rgba(23, 162, 184, 0.3);
            border: 1px solid #17a2b8;
            color: #d1ecf1;
        }
        
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .btn.primary {
            background: rgba(40, 167, 69, 0.8);
            border-color: #28a745;
        }
        
        .btn.danger {
            background: rgba(220, 53, 69, 0.8);
            border-color: #dc3545;
        }
        
        pre {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Production Domain Diagnostic</h1>
            <p>Diagnose why real-time settings sync isn't working on heroshealth.com</p>
            <div class="result info">
                <strong>Current Domain:</strong> <span id="current-domain"></span><br>
                <strong>Protocol:</strong> <span id="current-protocol"></span><br>
                <strong>Full Origin:</strong> <span id="current-origin"></span>
            </div>
        </div>

        <div class="diagnostic-panel">
            <h3>üîß Quick Fixes</h3>
            <div style="text-align: center;">
                <button class="btn primary" onclick="createProductionSettings()">‚ö° Create Production Settings</button>
                <button class="btn" onclick="importFromDevelopment()">üì• Import Dev Settings</button>
                <button class="btn danger" onclick="clearAllProductionData()">üóëÔ∏è Clear Production Data</button>
            </div>
        </div>

        <div class="diagnostic-panel">
            <h3>ü©∫ Diagnostic Tests</h3>
            <button class="btn" onclick="runFullDiagnostic()">üß™ Run Full Diagnostic</button>
            <button class="btn" onclick="testRealTimeSync()">‚ö° Test Real-time Sync</button>
            <div id="diagnostic-results">
                <div class="result info">Click "Run Full Diagnostic" to check all systems</div>
            </div>
        </div>

        <div class="diagnostic-panel">
            <h3>üìä Environment Analysis</h3>
            <div id="environment-analysis">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <div class="diagnostic-panel">
            <h3>üîÑ Real-time Test</h3>
            <p>Test if changes propagate in real-time on this domain:</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h4>Diabetes Care Menu</h4>
                    <button class="btn" onclick="toggleSetting('menu-diabetes-care')" id="btn-menu-diabetes-care">Toggle</button>
                    <div id="status-menu-diabetes-care" class="result info" style="margin-top: 10px;">Status: Unknown</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h4>Weight Loss Section</h4>
                    <button class="btn" onclick="toggleSetting('section-weight-loss')" id="btn-section-weight-loss">Toggle</button>
                    <div id="status-section-weight-loss" class="result info" style="margin-top: 10px;">Status: Unknown</div>
                </div>
            </div>
            <div id="realtime-log" style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <div style="color: #17a2b8;">[Initialized] Real-time sync test ready</div>
            </div>
        </div>
    </div>

    <script>
        let diagnosticResults = [];
        let realtimeEvents = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-domain').textContent = window.location.hostname;
            document.getElementById('current-protocol').textContent = window.location.protocol;
            document.getElementById('current-origin').textContent = window.location.origin;
            
            analyzeEnvironment();
            updateSettingStates();
        });

        function logRealtime(message, type = 'info') {
            const logDiv = document.getElementById('realtime-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#17a2b8',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107'
            };
            
            const entry = document.createElement('div');
            entry.style.color = colors[type];
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            realtimeEvents++;
        }

        function addDiagnosticResult(message, type = 'info') {
            const container = document.getElementById('diagnostic-results');
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.innerHTML = message;
            container.appendChild(result);
        }

        function clearDiagnosticResults() {
            document.getElementById('diagnostic-results').innerHTML = '';
        }

        function analyzeEnvironment() {
            const analysisDiv = document.getElementById('environment-analysis');
            const analysis = [];
            
            // Basic environment info
            analysis.push(`<strong>Domain:</strong> ${window.location.hostname}`);
            analysis.push(`<strong>Protocol:</strong> ${window.location.protocol}`);
            analysis.push(`<strong>User Agent:</strong> ${navigator.userAgent.split(' ').slice(-2).join(' ')}`);
            
            // Feature detection
            const features = {
                'localStorage': typeof Storage !== 'undefined',
                'BroadcastChannel': typeof BroadcastChannel !== 'undefined',
                'postMessage': typeof window.postMessage === 'function',
                'CustomEvent': typeof CustomEvent !== 'undefined',
                'StorageEvent': typeof StorageEvent !== 'undefined'
            };
            
            analysis.push('<strong>Feature Support:</strong>');
            Object.keys(features).forEach(feature => {
                const supported = features[feature];
                analysis.push(`&nbsp;&nbsp;${feature}: ${supported ? '‚úÖ Supported' : '‚ùå Not Supported'}`);
            });
            
            // LocalStorage check
            try {
                const testKey = 'production-diagnostic-test';
                localStorage.setItem(testKey, 'test');
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                analysis.push(`<strong>LocalStorage:</strong> ${retrieved === 'test' ? '‚úÖ Working' : '‚ùå Failed'}`);
            } catch (error) {
                analysis.push(`<strong>LocalStorage:</strong> ‚ùå Error: ${error.message}`);
            }
            
            // Current settings check
            const settingsData = localStorage.getItem('herosSiteSettings');
            if (settingsData) {
                try {
                    const settings = JSON.parse(settingsData);
                    const count = Object.keys(settings).length;
                    analysis.push(`<strong>Current Settings:</strong> ‚úÖ Found ${count} settings`);
                } catch (error) {
                    analysis.push(`<strong>Current Settings:</strong> ‚ùå Invalid JSON`);
                }
            } else {
                analysis.push(`<strong>Current Settings:</strong> ‚ö†Ô∏è No settings found (fresh domain)`);
            }
            
            analysisDiv.innerHTML = analysis.join('<br>');
        }

        function createProductionSettings() {
            try {
                const productionSettings = {
                    // Menu settings
                    'menu-weight-loss': true,
                    'menu-mens-ed': true,
                    'menu-skin-care': true,
                    'menu-hair-regrowth': true,
                    'menu-nad-plus': true,
                    'menu-diabetes-care': false, // Disabled for demo
                    
                    // Section settings
                    'section-hero': true,
                    'section-service-cards': true,
                    'section-products': true,
                    'section-weight-loss': false, // Disabled for demo
                    'section-ed-meds': true,
                    'section-results': true,
                    
                    // Carousel settings
                    'carousel-weight-loss': true,
                    'carousel-diabetes-care': false, // Disabled for demo
                    'carousel-hair-regrowth': true,
                    'carousel-mens-ed': true,
                    'carousel-skin-care': true,
                    
                    // Meta
                    'production-created': true,
                    'created-timestamp': Date.now(),
                    'domain': window.location.hostname
                };
                
                localStorage.setItem('herosSiteSettings', JSON.stringify(productionSettings));
                
                const changeNotification = {
                    timestamp: Date.now(),
                    setting: 'production-setup',
                    action: 'create-production-settings',
                    domain: window.location.hostname
                };
                localStorage.setItem('herosSettingsChange', JSON.stringify(changeNotification));
                
                alert('‚úÖ Production settings created!\n\nDiabetes Care and Weight Loss items are disabled for demonstration.\n\nRefresh any open main site tabs to see changes.');
                
                analyzeEnvironment();
                updateSettingStates();
                
                logRealtime('Production settings created with demo disabled items', 'success');
                
            } catch (error) {
                alert(`‚ùå Error creating production settings: ${error.message}`);
                logRealtime(`Error creating settings: ${error.message}`, 'error');
            }
        }

        function importFromDevelopment() {
            const devSettings = prompt('Paste settings JSON from development environment:');
            if (devSettings) {
                try {
                    const settings = JSON.parse(devSettings);
                    localStorage.setItem('herosSiteSettings', JSON.stringify(settings));
                    
                    const changeNotification = {
                        timestamp: Date.now(),
                        setting: 'import-dev',
                        action: 'import-from-development'
                    };
                    localStorage.setItem('herosSettingsChange', JSON.stringify(changeNotification));
                    
                    alert('‚úÖ Settings imported from development!');
                    analyzeEnvironment();
                    updateSettingStates();
                    logRealtime('Settings imported from development', 'success');
                    
                } catch (error) {
                    alert(`‚ùå Invalid JSON: ${error.message}`);
                    logRealtime(`Import error: ${error.message}`, 'error');
                }
            }
        }

        function clearAllProductionData() {
            if (confirm('üóëÔ∏è Clear all production settings?\n\nThis will remove all settings data and cannot be undone.')) {
                localStorage.removeItem('herosSiteSettings');
                localStorage.removeItem('herosSettingsChange');
                
                // Clear any individual settings
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('heros_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                alert('‚úÖ All production data cleared!');
                analyzeEnvironment();
                updateSettingStates();
                logRealtime('All production data cleared', 'warning');
            }
        }

        function runFullDiagnostic() {
            clearDiagnosticResults();
            addDiagnosticResult('üß™ Running full diagnostic on production domain...', 'info');
            
            // Test 1: LocalStorage functionality
            try {
                const testKey = 'diagnostic-test-' + Date.now();
                localStorage.setItem(testKey, 'test-value');
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === 'test-value') {
                    addDiagnosticResult('‚úÖ LocalStorage: Working correctly', 'pass');
                } else {
                    addDiagnosticResult('‚ùå LocalStorage: Read/write failed', 'fail');
                }
            } catch (error) {
                addDiagnosticResult(`‚ùå LocalStorage: Error - ${error.message}`, 'fail');
            }
            
            // Test 2: Settings presence
            const settingsData = localStorage.getItem('herosSiteSettings');
            if (settingsData) {
                try {
                    const settings = JSON.parse(settingsData);
                    addDiagnosticResult(`‚úÖ Settings Found: ${Object.keys(settings).length} items`, 'pass');
                } catch (error) {
                    addDiagnosticResult('‚ùå Settings: Invalid JSON format', 'fail');
                }
            } else {
                addDiagnosticResult('‚ö†Ô∏è Settings: No settings found (empty domain)', 'warning');
            }
            
            // Test 3: Change notification system
            try {
                const testNotification = {
                    timestamp: Date.now(),
                    setting: 'diagnostic-test',
                    action: 'test-notification'
                };
                localStorage.setItem('herosSettingsChange', JSON.stringify(testNotification));
                addDiagnosticResult('‚úÖ Change Notification: System working', 'pass');
            } catch (error) {
                addDiagnosticResult(`‚ùå Change Notification: Error - ${error.message}`, 'fail');
            }
            
            // Test 4: BroadcastChannel
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channel = new BroadcastChannel('diagnostic-test');
                    channel.close();
                    addDiagnosticResult('‚úÖ BroadcastChannel: Supported', 'pass');
                } catch (error) {
                    addDiagnosticResult(`‚ùå BroadcastChannel: Error - ${error.message}`, 'fail');
                }
            } else {
                addDiagnosticResult('‚ö†Ô∏è BroadcastChannel: Not supported in this browser', 'warning');
            }
            
            // Test 5: PostMessage
            try {
                window.postMessage({ type: 'diagnostic-test' }, '*');
                addDiagnosticResult('‚úÖ PostMessage: Working', 'pass');
            } catch (error) {
                addDiagnosticResult(`‚ùå PostMessage: Error - ${error.message}`, 'fail');
            }
            
            addDiagnosticResult('‚úÖ Full diagnostic complete', 'info');
        }

        function testRealTimeSync() {
            logRealtime('Starting real-time sync test...', 'info');
            
            // Create test setting change
            const settings = JSON.parse(localStorage.getItem('herosSiteSettings') || '{}');
            settings['realtime-test'] = !settings['realtime-test'];
            
            localStorage.setItem('herosSiteSettings', JSON.stringify(settings));
            
            const changeNotification = {
                timestamp: Date.now(),
                setting: 'realtime-test',
                value: settings['realtime-test'],
                action: 'diagnostic-sync-test'
            };
            localStorage.setItem('herosSettingsChange', JSON.stringify(changeNotification));
            
            // Try BroadcastChannel
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channel = new BroadcastChannel('heros-settings');
                    channel.postMessage({
                        type: 'heroSettingChanged',
                        setting: 'realtime-test',
                        value: settings['realtime-test'],
                        source: 'diagnostic'
                    });
                    channel.close();
                    logRealtime('BroadcastChannel message sent', 'success');
                } catch (error) {
                    logRealtime(`BroadcastChannel error: ${error.message}`, 'error');
                }
            }
            
            // Try window message
            try {
                window.postMessage({
                    type: 'heroSettingChanged',
                    setting: 'realtime-test',
                    value: settings['realtime-test'],
                    source: 'diagnostic'
                }, '*');
                logRealtime('Window message sent', 'success');
            } catch (error) {
                logRealtime(`Window message error: ${error.message}`, 'error');
            }
            
            logRealtime(`Test complete: realtime-test = ${settings['realtime-test']}`, 'info');
        }

        function toggleSetting(settingKey) {
            const settings = JSON.parse(localStorage.getItem('herosSiteSettings') || '{}');
            settings[settingKey] = !settings[settingKey];
            
            localStorage.setItem('herosSiteSettings', JSON.stringify(settings));
            
            const changeNotification = {
                timestamp: Date.now(),
                setting: settingKey,
                value: settings[settingKey],
                action: 'manual-toggle'
            };
            localStorage.setItem('herosSettingsChange', JSON.stringify(changeNotification));
            
            updateSettingStates();
            logRealtime(`Toggled ${settingKey} to ${settings[settingKey]}`, 'success');
        }

        function updateSettingStates() {
            const settings = JSON.parse(localStorage.getItem('herosSiteSettings') || '{}');
            
            ['menu-diabetes-care', 'section-weight-loss'].forEach(settingKey => {
                const statusDiv = document.getElementById(`status-${settingKey}`);
                const isEnabled = settings[settingKey] !== false;
                
                if (statusDiv) {
                    statusDiv.textContent = `Status: ${isEnabled ? 'Enabled' : 'Disabled'}`;
                    statusDiv.className = `result ${isEnabled ? 'pass' : 'warning'}`;
                }
            });
        }

        // Monitor for storage changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'herosSiteSettings' || e.key === 'herosSettingsChange') {
                logRealtime(`Storage event: ${e.key}`, 'info');
                updateSettingStates();
            }
        });

        // Monitor for window messages
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'heroSettingChanged') {
                logRealtime(`Window message: ${e.data.setting} = ${e.data.value}`, 'success');
            }
        });
    </script>
</body>
</html>
