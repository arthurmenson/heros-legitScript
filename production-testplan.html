<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Test Plan - Heros Health Settings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .domain-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }

        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .test-step {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .test-step h3 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .test-button {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }

        .test-button:hover {
            background: #218838;
        }

        .test-button.secondary {
            background: #6c757d;
        }

        .test-button.warning {
            background: #ffc107;
            color: #212529;
        }

        .test-button.danger {
            background: #dc3545;
        }

        .results-panel {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pass { background: #28a745; }
        .status-fail { background: #dc3545; }
        .status-pending { background: #ffc107; }
        .status-info { background: #17a2b8; }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .checklist li:last-child {
            border-bottom: none;
        }

        .diagnostics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .diagnostic-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .emergency-contact {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Heros Health Production Test Plan</h1>
            <p>Comprehensive testing suite for settings.html preview functionality on heroshealth.com</p>
            
            <div class="domain-info">
                <h3>üåê Current Testing Environment</h3>
                <div id="domain-status">
                    <span class="status-indicator status-pending"></span>
                    <span id="current-domain">Loading...</span>
                </div>
                <div style="margin-top: 10px;">
                    <small>Last updated: <span id="last-updated">Never</span></small>
                </div>
            </div>
        </div>

        <!-- Test Progress -->
        <div class="test-section">
            <h2>üìä Test Progress</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p>Completed: <span id="completed-tests">0</span> / <span id="total-tests">12</span> tests</p>
        </div>

        <!-- Critical Path Tests -->
        <div class="test-section">
            <h2>üéØ Critical Path Tests</h2>
            <p>These tests must pass for preview functionality to work on heroshealth.com</p>
            
            <div class="test-step">
                <h3>Test 1: Domain Detection</h3>
                <p>Verify we're running on the correct production domain</p>
                <button class="test-button" onclick="runDomainTest()">Run Domain Test</button>
                <div id="domain-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 2: LocalStorage Accessibility</h3>
                <p>Check if localStorage is accessible and writable on the production domain</p>
                <button class="test-button" onclick="runLocalStorageTest()">Test LocalStorage</button>
                <div id="localStorage-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 3: Settings Page Availability</h3>
                <p>Verify settings.html is accessible and loads correctly</p>
                <button class="test-button" onclick="runSettingsPageTest()">Test Settings Page</button>
                <div id="settingsPage-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 4: Preview Section DOM Elements</h3>
                <p>Check if all required DOM elements for preview functionality exist</p>
                <button class="test-button" onclick="runDOMTest()">Test DOM Elements</button>
                <div id="dom-result"></div>
            </div>
        </div>

        <!-- Preview Functionality Tests -->
        <div class="test-section">
            <h2>üñºÔ∏è Preview Functionality Tests</h2>
            
            <div class="test-step">
                <h3>Test 5: Toggle Preview Function</h3>
                <p>Test the ability to show/hide the preview section</p>
                <button class="test-button" onclick="runTogglePreviewTest()">Test Toggle Preview</button>
                <div id="togglePreview-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 6: Iframe Source Loading</h3>
                <p>Test if the preview iframe can load index.html correctly</p>
                <button class="test-button" onclick="runIframeLoadTest()">Test Iframe Loading</button>
                <div id="iframeLoad-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 7: Refresh Preview Function</h3>
                <p>Test the ability to refresh the preview iframe</p>
                <button class="test-button" onclick="runRefreshPreviewTest()">Test Refresh Preview</button>
                <div id="refreshPreview-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 8: Real-time Settings Sync</h3>
                <p>Test if settings changes are reflected in the preview immediately</p>
                <button class="test-button" onclick="runRealtimeSyncTest()">Test Real-time Sync</button>
                <div id="realtimeSync-result"></div>
            </div>
        </div>

        <!-- Settings Integration Tests -->
        <div class="test-section">
            <h2>‚öôÔ∏è Settings Integration Tests</h2>
            
            <div class="test-step">
                <h3>Test 9: Settings Data Persistence</h3>
                <p>Test if settings are properly saved and loaded from localStorage</p>
                <button class="test-button" onclick="runSettingsPersistenceTest()">Test Settings Persistence</button>
                <div id="settingsPersistence-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 10: Toggle Functionality</h3>
                <p>Test if individual setting toggles work correctly</p>
                <button class="test-button" onclick="runToggleFunctionalityTest()">Test Toggle Functionality</button>
                <div id="toggleFunctionality-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 11: Cross-tab Communication</h3>
                <p>Test if changes in settings.html are reflected in main site tabs</p>
                <button class="test-button" onclick="runCrossTabTest()">Test Cross-tab Communication</button>
                <div id="crossTab-result"></div>
            </div>

            <div class="test-step">
                <h3>Test 12: Production Scripts Loading</h3>
                <p>Test if all production-specific scripts are loading correctly</p>
                <button class="test-button" onclick="runProductionScriptsTest()">Test Production Scripts</button>
                <div id="productionScripts-result"></div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="test-section">
            <h2>‚ö° Quick Actions</h2>
            <button class="test-button" onclick="runAllTests()">üöÄ Run All Tests</button>
            <button class="test-button secondary" onclick="runDiagnostics()">üîç Run Diagnostics</button>
            <button class="test-button warning" onclick="applyProductionFixes()">üîß Apply Production Fixes</button>
            <button class="test-button danger" onclick="resetTestEnvironment()">üîÑ Reset Test Environment</button>
        </div>

        <!-- Live Diagnostics -->
        <div class="test-section">
            <h2>üìã Live Diagnostics</h2>
            <div class="diagnostics-grid">
                <div class="diagnostic-card">
                    <h4>üåê Environment</h4>
                    <ul>
                        <li>Domain: <span id="diag-domain">-</span></li>
                        <li>Protocol: <span id="diag-protocol">-</span></li>
                        <li>Page: <span id="diag-page">-</span></li>
                        <li>User Agent: <span id="diag-useragent">-</span></li>
                    </ul>
                </div>
                
                <div class="diagnostic-card">
                    <h4>üíæ Storage</h4>
                    <ul>
                        <li>LocalStorage: <span id="diag-localstorage">-</span></li>
                        <li>Settings Count: <span id="diag-settings-count">-</span></li>
                        <li>Change Notifications: <span id="diag-notifications">-</span></li>
                    </ul>
                </div>
                
                <div class="diagnostic-card">
                    <h4>üéõÔ∏è Functions</h4>
                    <ul>
                        <li>togglePreview: <span id="diag-toggle-preview">-</span></li>
                        <li>refreshPreview: <span id="diag-refresh-preview">-</span></li>
                        <li>applySettings: <span id="diag-apply-settings">-</span></li>
                        <li>saveSettings: <span id="diag-save-settings">-</span></li>
                    </ul>
                </div>
                
                <div class="diagnostic-card">
                    <h4>üèóÔ∏è DOM Elements</h4>
                    <ul>
                        <li>Preview Section: <span id="diag-preview-section">-</span></li>
                        <li>Preview Iframe: <span id="diag-preview-iframe">-</span></li>
                        <li>Toggle Elements: <span id="diag-toggle-elements">-</span></li>
                    </ul>
                </div>
            </div>
            
            <button class="test-button" onclick="updateDiagnostics()">üîÑ Update Diagnostics</button>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h2>üìù Test Results</h2>
            <div class="results-panel" id="test-results">
                <div style="color: #4CAF50;">üöÄ Production Test Plan Ready</div>
                <div>Click "Run All Tests" to begin comprehensive testing...</div>
                <div style="margin-top: 10px; color: #FFC107;">üí° Individual tests can be run separately for focused debugging</div>
            </div>
        </div>

        <!-- Emergency Contact -->
        <div class="emergency-contact">
            <h3>üÜò If Tests Fail</h3>
            <p><strong>Don't panic!</strong> Copy the test results and diagnostics information. The test plan includes automated fixes that will resolve most issues.</p>
            
            <h4>üîß Auto-fix Options:</h4>
            <ul class="checklist">
                <li>‚úÖ Apply Production Fixes - Automatically configures production settings</li>
                <li>‚úÖ Reset Test Environment - Clears problematic data and starts fresh</li>
                <li>‚úÖ Enhanced Diagnostics - Provides detailed information for debugging</li>
                <li>‚úÖ Manual Recovery Steps - Step-by-step instructions for manual fixes</li>
            </ul>
        </div>
    </div>

    <script>
        let testResults = [];
        let currentTestIndex = 0;
        const totalTests = 12;

        // Initialize page
        function init() {
            log('üöÄ Production Test Plan Initialized');
            updateDomainStatus();
            updateDiagnostics();
            
            // Auto-detect if we're on heroshealth.com
            if (window.location.hostname.includes('heroshealth.com')) {
                log('üåê Production domain detected - heroshealth.com');
                // Auto-load production fixes if needed
                setTimeout(() => {
                    if (confirm('üè• Production domain detected! Would you like to automatically apply production fixes for optimal performance?')) {
                        applyProductionFixes();
                    }
                }, 2000);
            }
        }

        function log(message, type = 'info') {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': '#4CAF50',
                'error': '#f44336',
                'warning': '#FF9800',
                'info': '#2196F3'
            };
            
            results.innerHTML += `<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function updateProgress() {
            const completedTests = testResults.filter(r => r.status !== 'pending').length;
            const progressPercent = (completedTests / totalTests) * 100;
            
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('completed-tests').textContent = completedTests;
            document.getElementById('total-tests').textContent = totalTests;
        }

        function updateDomainStatus() {
            const domain = window.location.hostname;
            const isProduction = domain.includes('heroshealth.com') || domain.includes('heros');
            
            document.getElementById('current-domain').textContent = domain;
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            
            const statusIndicator = document.querySelector('#domain-status .status-indicator');
            if (isProduction) {
                statusIndicator.className = 'status-indicator status-pass';
            } else {
                statusIndicator.className = 'status-indicator status-info';
            }
        }

        function updateDiagnostics() {
            // Environment diagnostics
            document.getElementById('diag-domain').textContent = window.location.hostname;
            document.getElementById('diag-protocol').textContent = window.location.protocol;
            document.getElementById('diag-page').textContent = window.location.pathname;
            document.getElementById('diag-useragent').textContent = navigator.userAgent.slice(0, 50) + '...';
            
            // Storage diagnostics
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                document.getElementById('diag-localstorage').textContent = '‚úÖ Working';
            } catch (e) {
                document.getElementById('diag-localstorage').textContent = '‚ùå Failed';
            }
            
            const settings = localStorage.getItem('herosSiteSettings');
            if (settings) {
                try {
                    const parsed = JSON.parse(settings);
                    document.getElementById('diag-settings-count').textContent = Object.keys(parsed).length;
                } catch (e) {
                    document.getElementById('diag-settings-count').textContent = 'Invalid JSON';
                }
            } else {
                document.getElementById('diag-settings-count').textContent = '0 (No settings)';
            }
            
            const notifications = localStorage.getItem('herosSettingsChange');
            document.getElementById('diag-notifications').textContent = notifications ? '‚úÖ Present' : '‚ùå None';
            
            // Function diagnostics
            document.getElementById('diag-toggle-preview').textContent = typeof window.togglePreview === 'function' ? '‚úÖ Available' : '‚ùå Missing';
            document.getElementById('diag-refresh-preview').textContent = typeof window.refreshPreview === 'function' ? '‚úÖ Available' : '‚ùå Missing';
            document.getElementById('diag-apply-settings').textContent = typeof window.applySettings === 'function' ? '‚úÖ Available' : '‚ùå Missing';
            document.getElementById('diag-save-settings').textContent = typeof window.saveSettings === 'function' ? '‚úÖ Available' : '‚ùå Missing';
            
            // DOM diagnostics
            document.getElementById('diag-preview-section').textContent = document.getElementById('preview-section') ? '‚úÖ Found' : '‚ùå Missing';
            document.getElementById('diag-preview-iframe').textContent = document.getElementById('preview-iframe') ? '‚úÖ Found' : '‚ùå Missing';
            document.getElementById('diag-toggle-elements').textContent = document.querySelectorAll('.toggle').length + ' found';
        }

        // Test implementations
        function runDomainTest() {
            log('üåê Running domain detection test...');
            
            const domain = window.location.hostname;
            const isProduction = domain.includes('heroshealth.com') || domain.includes('heros');
            
            if (isProduction) {
                log(`‚úÖ Production domain detected: ${domain}`, 'success');
                updateTestResult('domain', 'pass', `Production domain: ${domain}`);
            } else {
                log(`‚ÑπÔ∏è Non-production domain: ${domain}`, 'info');
                updateTestResult('domain', 'info', `Non-production domain: ${domain}`);
            }
        }

        function runLocalStorageTest() {
            log('üíæ Testing localStorage functionality...');
            
            try {
                const testKey = 'heros-test-' + Date.now();
                const testValue = 'test-value-' + Math.random();
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    log('‚úÖ LocalStorage read/write test passed', 'success');
                    updateTestResult('localStorage', 'pass', 'Read/write operations working');
                } else {
                    log('‚ùå LocalStorage read/write test failed', 'error');
                    updateTestResult('localStorage', 'fail', 'Read/write operations failed');
                }
                
            } catch (error) {
                log(`‚ùå LocalStorage error: ${error.message}`, 'error');
                updateTestResult('localStorage', 'fail', error.message);
            }
        }

        function runSettingsPageTest() {
            log('üìÑ Testing settings page availability...');
            
            const isSettingsPage = window.location.pathname.includes('settings.html');
            
            if (isSettingsPage) {
                log('‚úÖ Currently on settings page', 'success');
                updateTestResult('settingsPage', 'pass', 'On settings.html');
            } else {
                log('‚ÑπÔ∏è Not on settings page, testing access...', 'info');
                
                // Test if we can access settings page
                fetch('settings.html', { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            log('‚úÖ Settings page is accessible', 'success');
                            updateTestResult('settingsPage', 'pass', 'Settings page accessible');
                        } else {
                            log('‚ùå Settings page not accessible', 'error');
                            updateTestResult('settingsPage', 'fail', `HTTP ${response.status}`);
                        }
                    })
                    .catch(error => {
                        log(`‚ùå Settings page test error: ${error.message}`, 'error');
                        updateTestResult('settingsPage', 'fail', error.message);
                    });
            }
        }

        function runDOMTest() {
            log('üèóÔ∏è Testing DOM elements for preview functionality...');
            
            const requiredElements = [
                { id: 'preview-section', name: 'Preview Section' },
                { id: 'preview-iframe', name: 'Preview Iframe' },
                { selector: '.toggle', name: 'Toggle Elements' },
                { id: 'debug-panel', name: 'Debug Panel' }
            ];
            
            const results = [];
            
            requiredElements.forEach(element => {
                let found = false;
                
                if (element.id) {
                    found = !!document.getElementById(element.id);
                } else if (element.selector) {
                    found = document.querySelectorAll(element.selector).length > 0;
                }
                
                results.push({ name: element.name, found });
                
                if (found) {
                    log(`‚úÖ ${element.name} found`, 'success');
                } else {
                    log(`‚ùå ${element.name} missing`, 'error');
                }
            });
            
            const allFound = results.every(r => r.found);
            const foundCount = results.filter(r => r.found).length;
            
            updateTestResult('dom', allFound ? 'pass' : 'fail', 
                `${foundCount}/${results.length} elements found`);
        }

        function runTogglePreviewTest() {
            log('üñºÔ∏è Testing toggle preview functionality...');
            
            if (typeof window.togglePreview !== 'function') {
                log('‚ùå togglePreview function not found', 'error');
                updateTestResult('togglePreview', 'fail', 'Function not available');
                return;
            }
            
            try {
                const previewSection = document.getElementById('preview-section');
                if (!previewSection) {
                    log('‚ùå Preview section not found', 'error');
                    updateTestResult('togglePreview', 'fail', 'Preview section missing');
                    return;
                }
                
                const initialDisplay = previewSection.style.display;
                
                // Test showing preview
                window.togglePreview();
                const afterShow = previewSection.style.display;
                
                // Test hiding preview
                window.togglePreview();
                const afterHide = previewSection.style.display;
                
                log(`‚úÖ Toggle preview test completed - Show: ${afterShow}, Hide: ${afterHide}`, 'success');
                updateTestResult('togglePreview', 'pass', 'Toggle functionality working');
                
            } catch (error) {
                log(`‚ùå Toggle preview error: ${error.message}`, 'error');
                updateTestResult('togglePreview', 'fail', error.message);
            }
        }

        function runIframeLoadTest() {
            log('üì∫ Testing iframe loading functionality...');
            
            const iframe = document.getElementById('preview-iframe');
            if (!iframe) {
                log('‚ùå Preview iframe not found', 'error');
                updateTestResult('iframeLoad', 'fail', 'Iframe element missing');
                return;
            }
            
            try {
                const originalSrc = iframe.src;
                const testUrl = window.location.origin + '/index.html?test=' + Date.now();
                
                log(`üîÑ Loading test URL in iframe: ${testUrl}`);
                
                let loadTimeout;
                let loadSuccessful = false;
                
                const onLoad = () => {
                    clearTimeout(loadTimeout);
                    loadSuccessful = true;
                    log('‚úÖ Iframe loaded successfully', 'success');
                    updateTestResult('iframeLoad', 'pass', 'Iframe loading working');
                };
                
                const onError = () => {
                    clearTimeout(loadTimeout);
                    log('‚ùå Iframe failed to load', 'error');
                    updateTestResult('iframeLoad', 'fail', 'Iframe loading failed');
                };
                
                iframe.addEventListener('load', onLoad, { once: true });
                iframe.addEventListener('error', onError, { once: true });
                
                loadTimeout = setTimeout(() => {
                    if (!loadSuccessful) {
                        log('‚è∞ Iframe load timeout', 'warning');
                        updateTestResult('iframeLoad', 'fail', 'Load timeout');
                    }
                }, 10000);
                
                iframe.src = testUrl;
                
            } catch (error) {
                log(`‚ùå Iframe load test error: ${error.message}`, 'error');
                updateTestResult('iframeLoad', 'fail', error.message);
            }
        }

        function runRefreshPreviewTest() {
            log('üîÑ Testing refresh preview functionality...');
            
            if (typeof window.refreshPreview !== 'function') {
                log('‚ùå refreshPreview function not found', 'error');
                updateTestResult('refreshPreview', 'fail', 'Function not available');
                return;
            }
            
            try {
                window.refreshPreview();
                log('‚úÖ Refresh preview function executed without errors', 'success');
                updateTestResult('refreshPreview', 'pass', 'Refresh functionality working');
                
            } catch (error) {
                log(`‚ùå Refresh preview error: ${error.message}`, 'error');
                updateTestResult('refreshPreview', 'fail', error.message);
            }
        }

        function runRealtimeSyncTest() {
            log('‚ö° Testing real-time settings sync...');
            
            try {
                // Create a test setting change
                const testSetting = 'test-realtime-sync';
                const testValue = Date.now();
                
                // Store test setting
                const currentSettings = JSON.parse(localStorage.getItem('herosSiteSettings') || '{}');
                currentSettings[testSetting] = testValue;
                localStorage.setItem('herosSiteSettings', JSON.stringify(currentSettings));
                
                // Create change notification
                const changeNotification = {
                    timestamp: Date.now(),
                    setting: testSetting,
                    value: testValue,
                    action: 'test-realtime-sync',
                    source: 'production-testplan'
                };
                localStorage.setItem('herosSettingsChange', JSON.stringify(changeNotification));
                
                // Trigger sync mechanisms
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'herosSiteSettings',
                    newValue: JSON.stringify(currentSettings),
                    storageArea: localStorage
                }));
                
                log('‚úÖ Real-time sync test signals sent', 'success');
                updateTestResult('realtimeSync', 'pass', 'Sync mechanisms working');
                
            } catch (error) {
                log(`‚ùå Real-time sync test error: ${error.message}`, 'error');
                updateTestResult('realtimeSync', 'fail', error.message);
            }
        }

        function runSettingsPersistenceTest() {
            log('üíæ Testing settings persistence...');
            
            try {
                const testKey = 'test-persistence-' + Date.now();
                const testValue = Math.random();
                
                // Test saving setting
                const currentSettings = JSON.parse(localStorage.getItem('herosSiteSettings') || '{}');
                currentSettings[testKey] = testValue;
                localStorage.setItem('herosSiteSettings', JSON.stringify(currentSettings));
                
                // Test loading setting
                const reloadedSettings = JSON.parse(localStorage.getItem('herosSiteSettings') || '{}');
                
                if (reloadedSettings[testKey] === testValue) {
                    log('‚úÖ Settings persistence test passed', 'success');
                    updateTestResult('settingsPersistence', 'pass', 'Save/load working');
                    
                    // Clean up test setting
                    delete reloadedSettings[testKey];
                    localStorage.setItem('herosSiteSettings', JSON.stringify(reloadedSettings));
                } else {
                    log('‚ùå Settings persistence test failed', 'error');
                    updateTestResult('settingsPersistence', 'fail', 'Save/load failed');
                }
                
            } catch (error) {
                log(`‚ùå Settings persistence error: ${error.message}`, 'error');
                updateTestResult('settingsPersistence', 'fail', error.message);
            }
        }

        function runToggleFunctionalityTest() {
            log('üîÄ Testing toggle functionality...');
            
            const toggles = document.querySelectorAll('.toggle');
            
            if (toggles.length === 0) {
                log('‚ùå No toggle elements found', 'error');
                updateTestResult('toggleFunctionality', 'fail', 'No toggles found');
                return;
            }
            
            try {
                const firstToggle = toggles[0];
                const initialState = firstToggle.classList.contains('active');
                
                // Simulate click
                const clickEvent = new Event('click', { bubbles: true });
                firstToggle.dispatchEvent(clickEvent);
                
                setTimeout(() => {
                    const newState = firstToggle.classList.contains('active');
                    
                    if (newState !== initialState) {
                        log(`‚úÖ Toggle functionality working - State changed from ${initialState} to ${newState}`, 'success');
                        updateTestResult('toggleFunctionality', 'pass', 'Toggle state changes working');
                    } else {
                        log('‚ùå Toggle functionality failed - State did not change', 'error');
                        updateTestResult('toggleFunctionality', 'fail', 'Toggle state not changing');
                    }
                }, 500);
                
            } catch (error) {
                log(`‚ùå Toggle functionality error: ${error.message}`, 'error');
                updateTestResult('toggleFunctionality', 'fail', error.message);
            }
        }

        function runCrossTabTest() {
            log('üåê Testing cross-tab communication...');
            
            try {
                // Open a test window
                const testUrl = window.location.origin + '/index.html?crossTabTest=' + Date.now();
                const testWindow = window.open(testUrl, '_blank', 'width=800,height=600');
                
                if (testWindow) {
                    log('‚úÖ Test window opened for cross-tab communication', 'success');
                    
                    // Send test message
                    setTimeout(() => {
                        const testMessage = {
                            type: 'heroSettingChanged',
                            setting: 'cross-tab-test',
                            value: true,
                            timestamp: Date.now(),
                            source: 'production-testplan'
                        };
                        
                        testWindow.postMessage(testMessage, '*');
                        log('üì§ Test message sent to new window', 'info');
                        
                        updateTestResult('crossTab', 'pass', 'Cross-tab communication working');
                        
                        // Close test window after delay
                        setTimeout(() => {
                            testWindow.close();
                            log('üóô Test window closed', 'info');
                        }, 3000);
                        
                    }, 1000);
                    
                } else {
                    log('‚ùå Could not open test window - popup blocked', 'error');
                    updateTestResult('crossTab', 'fail', 'Popup blocked');
                }
                
            } catch (error) {
                log(`‚ùå Cross-tab test error: ${error.message}`, 'error');
                updateTestResult('crossTab', 'fail', error.message);
            }
        }

        function runProductionScriptsTest() {
            log('üìú Testing production scripts loading...');
            
            const expectedScripts = [
                'realtime-sync-fix.js',
                'production-quickfix.js',
                'production-preview-fix.js'
            ];
            
            const foundScripts = [];
            const scripts = document.querySelectorAll('script[src]');
            
            scripts.forEach(script => {
                const src = script.src;
                expectedScripts.forEach(expectedScript => {
                    if (src.includes(expectedScript)) {
                        foundScripts.push(expectedScript);
                    }
                });
            });
            
            // Check for global objects created by scripts
            const globalObjects = [
                'HerosSyncFix',
                'HerosProductionFix',
                'ProductionPreviewFix'
            ];
            
            const foundObjects = globalObjects.filter(obj => typeof window[obj] !== 'undefined');
            
            log(`‚úÖ Found ${foundScripts.length}/${expectedScripts.length} expected scripts`, foundScripts.length === expectedScripts.length ? 'success' : 'warning');
            log(`‚úÖ Found ${foundObjects.length}/${globalObjects.length} global objects`, foundObjects.length > 0 ? 'success' : 'warning');
            
            const allWorking = foundScripts.length > 0 || foundObjects.length > 0;
            updateTestResult('productionScripts', allWorking ? 'pass' : 'warning', 
                `${foundScripts.length} scripts, ${foundObjects.length} objects`);
        }

        function updateTestResult(testName, status, details) {
            // Update or add test result
            const existingIndex = testResults.findIndex(r => r.name === testName);
            const result = { name: testName, status, details, timestamp: Date.now() };
            
            if (existingIndex >= 0) {
                testResults[existingIndex] = result;
            } else {
                testResults.push(result);
            }
            
            // Update UI element
            const resultElement = document.getElementById(testName + '-result');
            if (resultElement) {
                const statusColor = {
                    'pass': '#4CAF50',
                    'fail': '#f44336',
                    'warning': '#FF9800',
                    'info': '#2196F3'
                }[status];
                
                resultElement.innerHTML = `<div style="color: ${statusColor}; margin-top: 10px;">
                    <strong>${status.toUpperCase()}:</strong> ${details}
                </div>`;
            }
            
            updateProgress();
        }

        // Quick action functions
        function runAllTests() {
            log('üöÄ Starting comprehensive test suite...', 'info');
            testResults = [];
            
            const tests = [
                runDomainTest,
                runLocalStorageTest,
                runSettingsPageTest,
                runDOMTest,
                runTogglePreviewTest,
                runIframeLoadTest,
                runRefreshPreviewTest,
                runRealtimeSyncTest,
                runSettingsPersistenceTest,
                runToggleFunctionalityTest,
                runCrossTabTest,
                runProductionScriptsTest
            ];
            
            tests.forEach((test, index) => {
                setTimeout(() => {
                    test();
                    
                    if (index === tests.length - 1) {
                        setTimeout(() => {
                            generateTestReport();
                        }, 1000);
                    }
                }, index * 500);
            });
        }

        function runDiagnostics() {
            log('üîç Running comprehensive diagnostics...', 'info');
            updateDiagnostics();
            
            // Enhanced diagnostics
            const diagnostics = {
                timestamp: new Date().toISOString(),
                domain: window.location.hostname,
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                localStorage: checkLocalStorageDetailed(),
                functions: checkFunctionAvailability(),
                dom: checkDOMElements(),
                settings: checkSettingsData(),
                errors: getRecentErrors()
            };
            
            log('üìä Detailed diagnostics completed:', 'success');
            console.log('Full Diagnostics Report:', diagnostics);
            
            // Store for support
            try {
                localStorage.setItem('heros-production-diagnostics', JSON.stringify(diagnostics));
                log('üíæ Diagnostics saved to localStorage', 'info');
            } catch (e) {
                log('‚ö†Ô∏è Could not save diagnostics to localStorage', 'warning');
            }
        }

        function applyProductionFixes() {
            log('üîß Applying production fixes...', 'info');
            
            try {
                // Load production scripts if not already loaded
                if (typeof HerosProductionFix === 'undefined') {
                    loadScript('production-quickfix.js');
                }
                
                if (typeof ProductionPreviewFix === 'undefined') {
                    loadScript('production-preview-fix.js');
                }
                
                // Apply immediate fixes
                setTimeout(() => {
                    if (typeof HerosProductionFix !== 'undefined') {
                        HerosProductionFix.init();
                        log('‚úÖ HerosProductionFix applied', 'success');
                    }
                    
                    if (typeof ProductionPreviewFix !== 'undefined') {
                        ProductionPreviewFix.enhance();
                        log('‚úÖ ProductionPreviewFix applied', 'success');
                    }
                    
                    log('üéâ Production fixes applied successfully', 'success');
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error applying production fixes: ${error.message}`, 'error');
            }
        }

        function resetTestEnvironment() {
            if (confirm('üîÑ This will reset all test data and cached settings. Continue?')) {
                log('üîÑ Resetting test environment...', 'warning');
                
                // Clear test data
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('test') || key.includes('heros-test')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Reset test results
                testResults = [];
                updateProgress();
                
                // Clear results panel
                document.getElementById('test-results').innerHTML = 
                    '<div style="color: #4CAF50;">üîÑ Test environment reset</div>' +
                    '<div>Ready for fresh testing...</div>';
                
                log('‚úÖ Test environment reset complete', 'success');
            }
        }

        // Helper functions
        function loadScript(src) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = () => log(`‚úÖ Loaded script: ${src}`, 'success');
            script.onerror = () => log(`‚ùå Failed to load script: ${src}`, 'error');
            document.head.appendChild(script);
        }

        function checkLocalStorageDetailed() {
            try {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.includes('heros')) {
                        data[key] = localStorage.getItem(key);
                    }
                }
                return { accessible: true, herosKeys: Object.keys(data).length, data };
            } catch (e) {
                return { accessible: false, error: e.message };
            }
        }

        function checkFunctionAvailability() {
            const functions = ['togglePreview', 'refreshPreview', 'applySettings', 'saveSettings'];
            const availability = {};
            functions.forEach(fn => {
                availability[fn] = typeof window[fn] === 'function';
            });
            return availability;
        }

        function checkDOMElements() {
            const elements = ['preview-section', 'preview-iframe', 'debug-panel'];
            const found = {};
            elements.forEach(id => {
                found[id] = !!document.getElementById(id);
            });
            found.toggles = document.querySelectorAll('.toggle').length;
            return found;
        }

        function checkSettingsData() {
            try {
                const settings = localStorage.getItem('herosSiteSettings');
                if (settings) {
                    const parsed = JSON.parse(settings);
                    return {
                        exists: true,
                        count: Object.keys(parsed).length,
                        hasProductionFlag: !!parsed['production-quickfix'],
                        sample: Object.keys(parsed).slice(0, 5)
                    };
                }
                return { exists: false };
            } catch (e) {
                return { exists: false, error: e.message };
            }
        }

        function getRecentErrors() {
            // This would typically collect from error handlers
            return { note: 'Error collection not implemented in test plan' };
        }

        function generateTestReport() {
            log('üìã Generating final test report...', 'info');
            
            const passedTests = testResults.filter(r => r.status === 'pass').length;
            const failedTests = testResults.filter(r => r.status === 'fail').length;
            const warningTests = testResults.filter(r => r.status === 'warning').length;
            
            log(`üìä TEST REPORT SUMMARY:`, 'info');
            log(`‚úÖ Passed: ${passedTests}`, 'success');
            log(`‚ùå Failed: ${failedTests}`, failedTests > 0 ? 'error' : 'info');
            log(`‚ö†Ô∏è Warnings: ${warningTests}`, warningTests > 0 ? 'warning' : 'info');
            
            if (failedTests === 0) {
                log(`üéâ All critical tests passed! Preview functionality should work on production.`, 'success');
            } else {
                log(`üîß ${failedTests} test(s) failed. Consider running "Apply Production Fixes".`, 'warning');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
